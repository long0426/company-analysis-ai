from google.adk.agents.llm_agent import Agent
from google.adk.models import LiteLlm
from google.adk.tools.mcp_tool import McpToolset, StdioConnectionParams
from mcp.client.stdio import StdioServerParameters  # ADK 1.21.0 å¯«æ³•
from dotenv import load_dotenv
from datetime import datetime
from pathlib import Path

# å•Ÿç”¨ MCP å›è¦†è¨˜éŒ„
from .mcp_toolset_wrapper import patch_mcp_tool
patch_mcp_tool()

# åŒ¯å…¥ MCP Log è®€å–å·¥å…·
from .mcp_log_reader import read_latest_mcp_response, format_mcp_response

load_dotenv()

# æ–°å¢é©—è­‰å·¥å…·
from .tools.format_key_message import validate_key_message
from .tools.prompt_verifier import extract_data_for_prompt
from .tools.calculate_upside import calculate_upside_potential
from .tools.save_output import save_agent_response

def extract_data_tool(ticker: str) -> str:
    """
    å¾ mcp_logs æå–å·²è¨˜éŒ„çš„é—œéµæ•¸æ“šï¼Œç”¨æ–¼æ’°å¯«å ±å‘Š
    æ­¤å·¥å…·æœƒå½™æ•´å¤šå€‹ log æª”æ¡ˆä¸­çš„æ•¸æ“š (åŒ…å« Yahoo Finance å’Œ Web Search)
    
    Args:
        ticker: è‚¡ç¥¨ä»£ç¢¼
        
    Returns:
        JSON æ ¼å¼çš„æ•´åˆæ•¸æ“š (extracted_data)
    """
    import json
    try:
        data = extract_data_for_prompt(ticker)
        # åªå›å‚³ extracted_data å’Œ source_mapï¼Œé¿å…è¿‡å¤šé›œè¨Š
        result = {
            "extracted_data": data["extracted_data"],
            "source_map": data["source_map"]
        }
        return json.dumps(result, ensure_ascii=False, indent=2)
    except Exception as e:
        return f"Error extracting data: {str(e)}"

def get_current_time() -> str:
    """å–å¾—ç•¶å‰æ™‚é–“"""
    return datetime.now().strftime("%Y-%m-%d %H:%M:%S")

def get_mcp_log(ticker: str) -> str:
    """
    è®€å–æŒ‡å®š ticker çš„æœ€æ–° MCP å›è¦†è¨˜éŒ„
    
    Args:
        ticker: è‚¡ç¥¨ä»£ç¢¼ï¼ˆä¾‹å¦‚ï¼š2330.TW, AAPLï¼‰
    
    Returns:
        MCP å›è¦†çš„åŸå§‹è³‡æ–™ï¼ˆJSON æ ¼å¼å­—ä¸²ï¼‰
    """
    import json
    response = read_latest_mcp_response(ticker)
    if not response:
        return f"âŒ æ‰¾ä¸åˆ° {ticker} çš„è¨˜éŒ„"
    
    # ç”¨ code block åŒ…è£ JSONï¼Œç¢ºä¿æ ¼å¼æ­£ç¢º
    json_str = json.dumps(response, ensure_ascii=False, indent=2)
    return f"```json\n{json_str}\n```"

def format_search_results(search_results_json: str) -> str:
    """
    æ ¼å¼åŒ–è‚¡ç¥¨æœå°‹çµæœï¼Œå¼·åˆ¶åŸ·è¡Œç”¨æˆ¶é¸æ“‡é‚è¼¯
    
    Args:
        search_results_json: yf_yfinance_search å›å‚³çš„ JSON å­—ä¸²ï¼ˆé™£åˆ—æ ¼å¼ï¼‰
    
    Returns:
        æ ¼å¼åŒ–å¾Œçš„è¨Šæ¯ï¼ŒåŒ…å«å€™é¸æ¸…å–®æˆ–å¾ŒçºŒæŒ‡ç¤º
    """
    import json
    
    try:
        data = json.loads(search_results_json)
        
        # è™•ç† MCP response çš„ä¸åŒæ ¼å¼
        # å¯èƒ½æ˜¯ç›´æ¥çš„é™£åˆ—ï¼Œä¹Ÿå¯èƒ½åŒ…åœ¨ content[0].text æˆ– structuredContent.result ä¸­
        if isinstance(data, list):
            results = data
        elif isinstance(data, dict):
            # å˜—è©¦å¾ content.text æå–
            if 'content' in data and isinstance(data['content'], list) and len(data['content']) > 0:
                text_content = data['content'][0].get('text', '')
                results = json.loads(text_content) if text_content else []
            # å˜—è©¦å¾ structuredContent.result æå–
            elif 'structuredContent' in data and 'result' in data['structuredContent']:
                result_text = data['structuredContent']['result']
                results = json.loads(result_text) if result_text else []
            else:
                return "âŒ æœå°‹çµæœæ ¼å¼éŒ¯èª¤ï¼Œè«‹é‡æ–°æœå°‹"
        else:
            return "âŒ æœå°‹çµæœæ ¼å¼éŒ¯èª¤ï¼Œè«‹é‡æ–°æœå°‹"
            
    except (json.JSONDecodeError, KeyError, ValueError) as e:
        return f"âŒ æœå°‹çµæœæ ¼å¼éŒ¯èª¤ï¼š{str(e)}"
    
    # ç¢ºä¿ results æ˜¯åˆ—è¡¨
    if not isinstance(results, list):
        return "âŒ æœå°‹çµæœæ ¼å¼éŒ¯èª¤ï¼ˆé æœŸç‚ºé™£åˆ—ï¼‰"
    
    # æƒ…æ³ 1: æ²’æœ‰æ‰¾åˆ°çµæœï¼ˆè§¸ç™¼ web-search å‚™æ´ï¼‰
    if not results or len(results) == 0:
        return """âš ï¸ Yahoo Finance æ‰¾ä¸åˆ°ç›¸é—œè‚¡ç¥¨

---
__AGENT_ACTION__: USE_WEB_SEARCH
---

ğŸ’¡ å°‡ä½¿ç”¨ç¶²è·¯æœå°‹ä¾†å°‹æ‰¾ ticker è³‡è¨Š..."""
    
    # æƒ…æ³ 2: åªæ‰¾åˆ°ä¸€å€‹çµæœï¼ˆè‡ªå‹•ç¹¼çºŒï¼Œä¸éœ€ç”¨æˆ¶ç¢ºèªï¼‰
    if len(results) == 1:
        item = results[0]
        symbol = item.get('symbol', 'N/A')
        name = item.get('longname') or item.get('shortname', 'N/A')
        exchange = item.get('exchDisp') or item.get('exchange', 'N/A')
        
        return f"""âœ… æ‰¾åˆ°å”¯ä¸€åŒ¹é…çµæœï¼š**{symbol}** - {name} ({exchange})

ï¿½ **è‡ªå‹•ä½¿ç”¨æ­¤ ticker ç¹¼çºŒæŸ¥è©¢...**

---
__AGENT_ACTION__: USE_TICKER={symbol}
---"""
    
    # æƒ…æ³ 3: æ‰¾åˆ°å¤šå€‹çµæœï¼ˆå¼·åˆ¶ç”¨æˆ¶é¸æ“‡ï¼‰
    lines = [f"æ‰¾åˆ° **{len(results)}** å€‹å€™é¸è‚¡ç¥¨ï¼Œè«‹é¸æ“‡ï¼š\n"]
    
    for idx, item in enumerate(results[:10], 1):  # æœ€å¤šé¡¯ç¤º 10 å€‹
        symbol = item.get('symbol', 'N/A')
        name = item.get('longname') or item.get('shortname', 'N/A')
        exchange = item.get('exchDisp') or item.get('exchange', 'N/A')
        sector = item.get('sectorDisp') or item.get('sector', '')
        
        lines.append(f"**{idx}. {symbol}**")
        lines.append(f"   åç¨±ï¼š{name}")
        lines.append(f"   äº¤æ˜“æ‰€ï¼š{exchange}")
        if sector:
            lines.append(f"   ç”¢æ¥­ï¼š{sector}")
        lines.append("")
    
    if len(results) > 10:
        lines.append(f"... é‚„æœ‰ {len(results) - 10} å€‹çµæœæœªé¡¯ç¤º\n")
    
    lines.append("ğŸ“Œ **è«‹å›è¦†ç·¨è™Ÿï¼ˆ1-10ï¼‰æˆ–ç›´æ¥è¼¸å…¥ ticker ä»£ç¢¼**")
    
    return "\n".join(lines)

# ============================================================================
# MCP å‹•æ…‹è¼‰å…¥è¨­å®š (Read from mcp_config.json)
# ============================================================================

def load_mcp_config():
    """è®€å– mcp_config.json ä¸¦å›å‚³ mcpServers è¨­å®š"""
    import json
    config_path = Path(__file__).parent.parent / "mcp_config.json"
    if not config_path.exists():
        print(f"âš ï¸ Config not found: {config_path}")
        return {}
    
    try:
        with open(config_path, "r", encoding="utf-8") as f:
            config = json.load(f)
        return config.get("mcpServers", {})
    except Exception as e:
        print(f"âŒ Error loading mcp_config.json: {e}")
        return {}

def load_system_prompt(filename: str) -> str:
    """
    å¾ system_prompt ç›®éŒ„è®€å–æŒ‡å®šçš„ prompt æª”æ¡ˆ
    
    Args:
        filename: æª”æ¡ˆåç¨±ï¼ˆä¾‹å¦‚ï¼š"get_ticker_info.md"ï¼‰
    
    Returns:
        prompt å…§å®¹å­—ä¸²
    """
    prompt_path = Path(__file__).parent / "system_prompt" / filename
    if not prompt_path.exists():
        print(f"âš ï¸ System prompt not found: {prompt_path}")
        return ""
    
    try:
        with open(prompt_path, "r", encoding="utf-8") as f:
            return f.read().strip()
    except Exception as e:
        print(f"âŒ Error loading system prompt: {e}")
        return ""

mcp_servers = load_mcp_config()
mcp_toolsets = []

# å®šç¾©å·¥å…·å‰ç¶´æ˜ å°„ (å› ç‚º mcp_config.json ä¸æ”¯æ´éæ¨™æº–æ¬„ä½)
prefix_mapping = {
    "yfinance": "yf_",      # Keep yf_ prefix for clarity
    "web-search": "web_",   # search_search -> web_search
    "fetch-webpage": "url_" # fetch_fetch -> url_fetch
}

for name, config in mcp_servers.items():
    try:
        # å»ºæ§‹åƒæ•¸
        server_params = StdioServerParameters(
            command=config.get("command"),
            args=config.get("args", []),
            env=config.get("env")  # è‹¥ç„¡å‰‡ç‚º None
        )
        
        # æ±ºå®š prefix
        prefix = prefix_mapping.get(name, f"{name.replace('-', '_')}_")
        
        # å»ºç«‹ Toolset
        toolset = McpToolset(
            connection_params=StdioConnectionParams(
                server_params=server_params,
                timeout=60.0
            ),
            tool_name_prefix=prefix
        )
        mcp_toolsets.append(toolset)
        print(f"âœ“ Loaded MCP server: {name} (prefix: {prefix})")
        
    except Exception as e:
        print(f"âŒ Failed to load MCP server {name}: {e}")

# ============================================================================
# Model Initialization (Must be before sub-agent functions)
# ============================================================================

model = LiteLlm(model="azure/gpt-4o")

# ============================================================================
# Sub-Agent & Orchestrator Tools
# ============================================================================

def run_ticker_discovery_task(user_query: str) -> str:
    """
    Step 1: åŸ·è¡Œ Ticker æ¢ç´¢èˆ‡è³‡æ–™ç²å–ä»»å‹™ã€‚
    ä½¿ç”¨ get_ticker_info.md æŒ‡ä»¤,è² è²¬æœå°‹ä»£ç¢¼ã€ç²å–è©³ç´°è³‡æ–™èˆ‡ Newsã€‚
    å°‡çµæœå¯«å…¥ agent_response.mdã€‚
    """
    print(f"\n{'='*60}")
    print(f"[Step 1] Running Discovery Task")
    print(f"User Query: {user_query}")
    print(f"{'='*60}\n")
    
    try:
        # è®€å– system prompt
        system_instruction = load_system_prompt("get_ticker_info.md")
        
        # æº–å‚™å·¥å…·è²æ˜ï¼ˆæ¨¡æ“¬ ADK çš„å·¥å…·æ ¼å¼ï¼‰
        from google.adk.toolkits import FunctionDeclaration
        
        tools_declarations = []
        
        # æ·»åŠ æœ¬åœ°å‡½æ•¸å·¥å…·
        for func in [get_current_time, get_mcp_log, format_search_results]:
            tools_declarations.append(FunctionDeclaration.from_function(func))
        
        # æ·»åŠ  MCP å·¥å…·ï¼ˆå±•é–‹ toolsetsï¼‰
        for toolset in mcp_toolsets:
            # ä½¿ç”¨ toolset çš„å…§éƒ¨æ–¹æ³•ç²å–å·¥å…·åˆ—è¡¨
            mcp_tools = toolset.get_tools()
            tools_declarations.extend(mcp_tools)
        
        print(f"âœ“ Prepared {len(tools_declarations)} tools for discovery")
        print("âœ“ Calling LLM with system prompt and tools...")
        
        # ç›´æ¥èª¿ç”¨ LLM
        response = model.generate_content(
            contents=user_query,
            config={
                "system_instruction": system_instruction,
                "tools": tools_declarations,
            }
        )
        
        # è™•ç†å·¥å…·èª¿ç”¨å’Œå›æ‡‰
        response_text = None
        if response.candidates:
            candidate = response.candidates[0]
            if candidate.content.parts:
                for part in candidate.content.parts:
                    if hasattr(part, 'text') and part.text:
                        response_text = part.text
                        break
        
        if not response_text:
            response_text = "Error: No response from LLM"
        
        print(f"\n{'='*60}")
        print(f"Discovery task completed")
        print(f"Response length: {len(response_text)} characters")
        print(f"{'='*60}\n")
        
        save_agent_response(response_text)
        
        # ç°¡æ˜“è§£æ Ticker
        import re
        import json
        clean_json = re.sub(r'^```json\s*|\s*```$', '', response_text.strip(), flags=re.MULTILINE)
        try:
            data = json.loads(clean_json)
            ticker = data.get("symbol")
            if not ticker and "info" in data:
                 ticker = data["info"].get("symbol")
            return ticker if ticker else "Error: Unable to extract Ticker from log."
        except:
            return "Error: Invalid JSON response from discovery agent."
    except Exception as e:
        import traceback
        error_detail = traceback.format_exc()
        print(f"Discovery task error:\n{error_detail}")
        return f"Error in discovery task: {str(e)}"

def run_key_message_task(ticker: str) -> str:
    """
    Step 2: åŸ·è¡Œé—œéµè¨Šæ¯ç”Ÿæˆä»»å‹™ã€‚
    ä½¿ç”¨ generate_key_message.md æŒ‡ä»¤,å°‡çµæœ Append åˆ° agent_response.mdã€‚
    """
    print(f"\n{'='*60}")
    print(f"[Step 2] Running Key Message Task")
    print(f"Ticker: {ticker}")
    print(f"{'='*60}\n")
    
    try:
        # è®€å– system prompt
        system_instruction = load_system_prompt("generate_key_message.md")
        
        # æº–å‚™å·¥å…·
        from google.adk.toolkits import FunctionDeclaration
        
        tools_declarations = []
        for func in [get_current_time, get_mcp_log, extract_data_tool, 
                     validate_key_message, calculate_upside_potential, 
                     save_agent_response, format_search_results]:
            tools_declarations.append(FunctionDeclaration.from_function(func))
        
        for toolset in mcp_toolsets:
            mcp_tools = toolset.get_tools()
            tools_declarations.extend(mcp_tools)
        
        print(f"âœ“ Prepared {len(tools_declarations)} tools for analysis")
        print("âœ“ Calling LLM with system prompt and tools...")
        
        # ç›´æ¥èª¿ç”¨ LLM
        response = model.generate_content(
            contents=ticker,
            config={
                "system_instruction": system_instruction,
                "tools": tools_declarations,
            }
        )
        
        print("Analysis complete")
        return "Key message generation completed."
    except Exception as e:
        import traceback
        error_detail = traceback.format_exc()
        print(f"Key message task error:\n{error_detail}")
        return f"Error in key message task: {str(e)}"
    """
    Step 1: åŸ·è¡Œ Ticker æ¢ç´¢èˆ‡è³‡æ–™ç²å–ä»»å‹™ã€‚
    ä½¿ç”¨ get_ticker_info.md æŒ‡ä»¤,è² è²¬æœå°‹ä»£ç¢¼ã€ç²å–è©³ç´°è³‡æ–™èˆ‡ Newsã€‚
    å°‡çµæœå¯«å…¥ agent_response.mdã€‚
    """
    print(f"\n{'='*60}")
    print(f"[Step 1] Running Discovery Task")
    print(f"User Query: {user_query}")
    print(f"{'='*60}\n")
    
    try:
        # å‰µå»º discovery agent
        discovery_agent = Agent(
            model=model,
            name='discovery_agent',
            instruction=load_system_prompt("get_ticker_info.md"),
            tools=[get_current_time, get_mcp_log, format_search_results] + mcp_toolsets
        )
        
        total_tools = len(discovery_agent.tools)
        print(f"âœ“ Discovery agent created successfully")
        print(f"âœ“ Total tools available: {total_tools}")
        print(f"  - Local functions: 3")
        print(f"  - MCP Toolsets: {len(mcp_toolsets)}")
        print()
        
        print("Executing discovery agent...")
        
        # ADK Agent éœ€è¦ç•°æ­¥åŸ·è¡Œ
        import asyncio
        from google.adk.sessions import Session
        
        # å‰µå»º session ä¸¦åŸ·è¡Œ
        session = Session(
            id=f"discovery_{user_query[:20]}",
            appName="stock_analysis",
            userId="system"
        )
        result = asyncio.run(discovery_agent.run_async(
            query=user_query,
            session=session
        ))
        
        # å–å¾—æœ€å¾Œçš„å›æ‡‰å…§å®¹
        if result and hasattr(result, 'text'):
            response_content = result.text
        elif isinstance(result, str):
            response_content = result
        else:
            response_content = str(result)
        
        print(f"\n{'='*60}")
        print(f"Discovery agent response received")
        print(f"Response length: {len(response_content)} characters")
        print(f"{'='*60}\n")
        save_agent_response(response_content)
        
        # ç°¡æ˜“è§£æ Ticker
        import re
        import json
        clean_json = re.sub(r'^```json\s*|\s*```$', '', response_content.strip(), flags=re.MULTILINE)
        try:
            data = json.loads(clean_json)
            ticker = data.get("symbol")
            if not ticker and "info" in data:
                 ticker = data["info"].get("symbol")
            return ticker if ticker else "Error: Unable to extract Ticker from log."
        except:
            return "Error: Invalid JSON response from discovery agent."
    except Exception as e:
        import traceback
        error_detail = traceback.format_exc()
        print(f"Discovery task error:\n{error_detail}")
        return f"Error in discovery task: {str(e)}"

def run_key_message_task(ticker: str) -> str:
    """
    Step 2: åŸ·è¡Œé—œéµè¨Šæ¯ç”Ÿæˆä»»å‹™ã€‚
    ä½¿ç”¨ generate_key_message.md æŒ‡ä»¤,å°‡çµæœ Append åˆ° agent_response.mdã€‚
    """
    print(f"\n{'='*60}")
    print(f"[Step 2] Running Key Message Task")
    print(f"Ticker: {ticker}")
    print(f"{'='*60}\n")
    
    try:
        analysis_agent = Agent(
            model=model,
            name='analysis_agent',
            instruction=load_system_prompt("generate_key_message.md"),
            tools=[
                get_current_time, get_mcp_log, extract_data_tool, 
                validate_key_message, calculate_upside_potential, 
                save_agent_response, format_search_results
            ] + mcp_toolsets
        )
        
        print(f"âœ“ Analysis agent created with {len(analysis_agent.tools)} tools")
        print("Executing analysis agent...")
        
        # ADK Agent éœ€è¦ç•°æ­¥åŸ·è¡Œ
        import asyncio
        from google.adk.sessions import Session
        
        session = Session(
            id=f"analysis_{ticker}",
            appName="stock_analysis",
            userId="system"
        )
        result = asyncio.run(analysis_agent.run_async(
            query=ticker,
            session=session
        ))
        
        print("Analysis complete")
        return "Key message generation completed."
    except Exception as e:
        import traceback
        error_detail = traceback.format_exc()
        print(f"Key message task error:\n{error_detail}")
        return f"Error in key message task: {str(e)}"

def read_agent_response_file() -> str:
    """Step 3: è®€å–æœ€çµ‚å ±å‘Šæª”æ¡ˆå…§å®¹ã€‚"""
    try:
        file_path = Path(__file__).parent / "agent_response.md"
        if not file_path.exists(): return "å°šæœªç”Ÿæˆä»»ä½•å ±å‘Šã€‚"
        return file_path.read_text(encoding="utf-8")
    except Exception as e:
        return f"Error reading file: {str(e)}"

# ============================================================================
# Core Agent (Orchestrator)
# ============================================================================

root_agent = Agent(
    model=model,
    name='stock_agent',
    description='Financial Analysis Orchestrator',
    instruction=load_system_prompt("orchestrator.md"),
    tools=[run_ticker_discovery_task, run_key_message_task, read_agent_response_file]
)

print(f"âœ“ Agent initialized with Orchestrator mode")
